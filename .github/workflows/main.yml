name: CI

on: [pull_request]

jobs:
  build:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v2
    - uses: docker-practice/actions-setup-docker@1.0.8
    - name: Test materialized formula
      # Ideally we would test a) building from source for the current
      # version, b) building from source for HEAD, and c) pouring the pre-built
      # bottle. Unfortunately building from source on GitHub VMs takes 30m+,
      # so presently we only truly test the bottle (c).
      #
      # To have some confidence in (a) and (b), we use `brew fetch` to
      # at least validate the source tarball and Git repository, respectively,
      # can be retrieved by Homebrew.
      run: |
        set -euo pipefail
        mkdir -p "$(dirname $(brew --repo ${{github.repository}}))"
        cp -a "$GITHUB_WORKSPACE" "$(brew --repo ${{github.repository}})"
        metadata=$(brew info --json materialized)
        version=$(jq -r .[0].versions.stable <<< "$metadata")
        sha=$(git ls-remote https://github.com/MaterializeInc/materialize.git "v$version^{}" | cut -f1)
        echo "MATERIALIZED_VERSION=$version" >> "$GITHUB_ENV"
        echo "version=$version" "sha=$sha" "bottle_hash=$bottle_hash"
        set -x
        brew fetch --build-from-source materialized
        brew fetch --HEAD materialized
        brew install materialized
        brew linkage --test materialized
        brew test materialized --verbose
        set +x
        if ! materialized --version 2>&1 | grep "${sha:0:9}"; then
          echo "materialized --version reports wrong version" >&2
          materialized --version
          exit 1
        fi
        for platform in mojave arm64_big_sur; do
          bottle_hash=$(jq -r .[0].bottle.stable.files."$platform".sha256 <<< "$metadata")
          echo "bottle_hash=$bottle_hash"
          bin/mkbottle "$version" "$platform"
          echo "$bottle_hash  bottle.$platform.tar.gz" | shasum -a 256 --check
        done
    - uses: actions/upload-artifact@v1
      if: failure()
      with:
        name: bottle
        path: materialized-${{env.MATERIALIZED_VERSION}}.*.bottle.tar.gz
